## 手写Ajax
`ajax`在我们的开发工作中已经司空见惯，几乎所有我们频繁使用的库和框架都提供了经过完善封装的ajax方法，如 `$.ajax`, `fetch`, `axios` 等等，这使得我们的数据请求都变得异常简洁明了

### XMLHttpRequest对象
我们常用的ajax就是用过XMLHttpRequest对象实现的。这个对象有很多的属性和事件，在使用之前，我们需要将它实例化
```js
const xhr = new XMLHttpRequest()
```
实例化后，我们就可以通过xhr来发送一个请求
```js
//xhr具有一个open方法,这个方法的作用类似于初始化,并不会发起真正的请求
//open 方法具有5个参数，但是常用的是前3个
//method：请求方式 -- get/post
//url:请求的地址
//async:是否异步请求，默认为true(异步)
xhr.open(method,url,async)

//send方法发送请求.并接受一个可选参数
//当请求方式为post时，可以将请求体的参数传入
//如果请求方式时get时,可以不传或者传入null
//不管是get还是post，参数都需要通过 encodeURLComponent 编码后拼接
xhr.send(data)
```
再通过send方法发送请求后，xhr对象在收到响应数据时会自动填充到其对应的属性中，xhr具有以下常用属性：

- responseText：请求返回的数据内容
- responseXML：如果响应内容时“text/xml” “application/xml”,这个属性将保存数据的XML DOM文档
- status：响应的HTTP状态，如200 304 404等
- statusText：HTTP状态说明
- readyStatus：请求/响应过程的当前活动阶段
- timeout：设置请求超时事件

上面写了这么多属性。我们并没有发现收到数据时的回调方法，那么该怎么在收到数据时进行处理呢？
这个问题的重点要放在readyStatus这个属性上

readyStatus的值会随着请求各阶段的变化而改变，其一共有5个值：

- xhr.readyStatus == 0 尚未调用 open 方法
- xhr.readyStatus ==1 已调用open但还未发送请求
- xhr.readyStatus ==2 已发送请求(已调用 send)
- xhr.readyStatus ==3 已经收到请求返回的数据
- xhr.readyStatus ==4 请求已完成

当readyStatus的状态发生改变时,会触发 xhr 的事件 onreadystatechange,于是我们就可以在这个方法中，对接收到的数据进行处理
```js
 xhr.onreadystatechange = ()=>{
    if (xhr.readyState === 4) {
        if (xhr.status === 200) {
            resolve(JSON.parse(xhr.responseText))
        } else if (xhr.status === 404 || xhr.status === 500) {
            reject(new Error('404 not found'))
        }
    }
 }
```
当网络不佳时，我们需要给请求设置一个超时时间
```js
//超时时间单位为毫秒
xhr.timeout = 1000

//当请求超时时，会触发ontimeout方法
xhr.ontimeout = () => console.log('请求超时')
```

### 相关面试题
**手写ajax**
```js
/**
 *  手写 ajax
 * @param {*} options 
 */
function myAjax(options) {
    let url = options.url
    const method = options.method.toLocaleLowerCase() || 'get'
    const async = options.async || false
    const data = options.data || {}

    const xhr = new XMLHttpRequest()
    xhr.open(method, url, async)

    if (options.timeout && options.timeout > 0) {
        xhr.timeout = options.timeout
    }

    return new Promise((resolve, reject) => {
        xhr.timeout = () => reject && reject('请求超时')
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    resolve(JSON.parse(xhr.responseText))
                } else if (xhr.status === 404 || xhr.status === 500) {
                    reject(new Error('404 not found'))
                }
            }
        }
        let paramArr = []
        let encodeData
        if (data instanceof Object) {
            for (let key in data) {
                paramArr.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]))
            }
            encodeData = paramArr.join('&')
        }
        if (method === 'get') {
            xhr.send(null)
        } else {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8')
            xhr.send(encodeData)
        }
    })
}
```

**使用**
```js
// 使用

myAjax({
    url: 'http://xxxx',
    method: 'post',
    async: true,
    timeout: 1000,
    data: {
        test: 1,
        aaa: 2
    }
}).then((res) => {
    console.log("res", res)
}).catch((err) => {
    console.log("err", err)
});
```